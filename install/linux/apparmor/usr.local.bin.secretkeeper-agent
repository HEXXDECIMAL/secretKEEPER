# AppArmor profile for SecretKeeper
# Install: sudo cp this_file /etc/apparmor.d/usr.local.bin.secretkeeper-agent
# Load: sudo apparmor_parser -r /etc/apparmor.d/usr.local.bin.secretkeeper-agent

#include <tunables/global>

profile secretkeeper /usr/local/bin/secretkeeper-agent {
  #include <abstractions/base>
  #include <abstractions/nameservice>

  # Binary itself
  /usr/local/bin/secretkeeper-agent mr,

  # Configuration files
  /etc/secretkeeper/ r,
  /etc/secretkeeper/** r,

  # Data directory (SQLite database)
  /var/lib/secretkeeper/ rw,
  /var/lib/secretkeeper/** rwk,

  # Unix socket for IPC
  /var/run/secretkeeper.sock rw,
  /run/secretkeeper.sock rw,

  # Fanotify requires extensive /proc access
  @{PROC}/ r,
  @{PROC}/sys/fs/fanotify/** r,
  @{PROC}/[0-9]*/ r,
  @{PROC}/[0-9]*/fd/ r,
  @{PROC}/[0-9]*/fd/* r,
  @{PROC}/[0-9]*/exe r,
  @{PROC}/[0-9]*/status r,
  @{PROC}/[0-9]*/cmdline r,
  @{PROC}/[0-9]*/comm r,
  @{PROC}/[0-9]*/cwd r,
  @{PROC}/[0-9]*/stat r,
  @{PROC}/self/fd/ r,
  @{PROC}/self/fd/* r,

  # Read access to monitored directories
  /home/** r,
  /root/** r,
  /etc/** r,

  # System libraries
  /lib/** mr,
  /lib64/** mr,
  /usr/lib/** mr,
  /usr/lib64/** mr,

  # Temp files (for SQLite)
  /tmp/ r,
  /tmp/** rwk,

  # Capabilities required
  capability sys_admin,
  capability kill,

  # Deny network access (not needed)
  deny network inet,
  deny network inet6,

  # Deny ptrace
  deny ptrace,

  # Deny mount operations
  deny mount,
  deny umount,
}
