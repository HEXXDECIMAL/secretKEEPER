# SELinux Type Enforcement policy for SecretKeeper
#
# Build and install:
#   cd install/linux/selinux
#   make -f /usr/share/selinux/devel/Makefile secretkeeper.pp
#   sudo semodule -i secretkeeper.pp
#   sudo restorecon -Rv /usr/local/bin/secretkeeper-agent /etc/secretkeeper /var/lib/secretkeeper

policy_module(secretkeeper, 1.0.0)

########################################
# Require statements
########################################
require {
    type init_t;
    type proc_t;
    type sysfs_t;
    type user_home_t;
    type user_home_dir_t;
    type etc_t;
    type var_lib_t;
    type var_run_t;
    type bin_t;
    type lib_t;
    type ld_so_t;
    type passwd_file_t;
    type tmp_t;
    class capability { kill sys_admin };
    class file { create getattr ioctl lock open read unlink write };
    class dir { add_name create getattr open read remove_name search write };
    class lnk_file { getattr read };
    class sock_file { create getattr unlink write };
    class unix_stream_socket { accept bind connectto create getattr listen read setopt shutdown write };
    class process { signal signull };
}

########################################
# Type declarations
########################################
type secretkeeper_t;
type secretkeeper_exec_t;
type secretkeeper_var_lib_t;
type secretkeeper_var_run_t;
type secretkeeper_etc_t;

# Mark as a domain
domain_type(secretkeeper_t)

# Mark executable type
init_daemon_domain(secretkeeper_t, secretkeeper_exec_t)

# Mark file types
files_type(secretkeeper_var_lib_t)
files_type(secretkeeper_var_run_t)
files_type(secretkeeper_etc_t)

########################################
# Local policy rules
########################################

# Allow execution from init
allow init_t secretkeeper_exec_t:file { execute open read };

# Allow secretkeeper domain transitions
allow secretkeeper_t secretkeeper_exec_t:file { entrypoint execute read };

# Allow reading /proc for process information
allow secretkeeper_t proc_t:file { getattr open read };
allow secretkeeper_t proc_t:dir { getattr open read search };
allow secretkeeper_t proc_t:lnk_file { getattr read };

# Allow reading user homes (for monitoring protected files)
allow secretkeeper_t user_home_t:file { getattr open read };
allow secretkeeper_t user_home_t:dir { getattr open read search };
allow secretkeeper_t user_home_dir_t:dir { getattr open read search };

# Allow reading /etc (for monitoring and config)
allow secretkeeper_t etc_t:file { getattr open read };
allow secretkeeper_t etc_t:dir { getattr open read search };
allow secretkeeper_t secretkeeper_etc_t:file { getattr open read };
allow secretkeeper_t secretkeeper_etc_t:dir { getattr open read search };

# Allow access to /var/lib/secretkeeper (SQLite database)
allow secretkeeper_t secretkeeper_var_lib_t:dir { add_name create getattr open read remove_name search write };
allow secretkeeper_t secretkeeper_var_lib_t:file { create getattr ioctl lock open read unlink write };

# Allow socket in /var/run
allow secretkeeper_t secretkeeper_var_run_t:sock_file { create getattr unlink write };
allow secretkeeper_t var_run_t:dir { add_name remove_name write };

# Unix socket operations
allow secretkeeper_t self:unix_stream_socket { accept bind create getattr listen read setopt shutdown write };

# Capabilities required for fanotify and process control
allow secretkeeper_t self:capability { kill sys_admin };

# Allow sending signals to processes (for SIGSTOP)
allow secretkeeper_t domain:process { signal signull };

# Allow reading system libraries
allow secretkeeper_t lib_t:file { execute getattr open read };
allow secretkeeper_t lib_t:dir { getattr open read search };
allow secretkeeper_t ld_so_t:file { execute getattr open read };
allow secretkeeper_t bin_t:dir { getattr open read search };

# Allow reading passwd for UID lookups
allow secretkeeper_t passwd_file_t:file { getattr open read };

# Allow temp files (SQLite WAL)
allow secretkeeper_t tmp_t:dir { add_name getattr open read remove_name search write };
allow secretkeeper_t tmp_t:file { create getattr ioctl lock open read unlink write };

# Allow reading sysfs for system information
allow secretkeeper_t sysfs_t:dir { getattr open read search };
allow secretkeeper_t sysfs_t:file { getattr open read };

########################################
# Dontaudit rules (reduce log noise)
########################################
dontaudit secretkeeper_t self:capability dac_override;
dontaudit secretkeeper_t self:capability dac_read_search;
